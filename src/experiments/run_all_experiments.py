#!/usr/bin/env python
import argparse
import subprocess
import sys
from pathlib import Path


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Run all experiments across all prompt specificity levels"
    )
    
    parser.add_argument(
        "--prompt_dir",
        type=str,
        default="/u/cz5047/reas-llm-uq/t2i-unc/prompts",
        help="Directory containing prompt JSONL files.",
    )
    
    parser.add_argument(
        "--base_out_dir",
        type=str,
        default="results",
        help="Base directory for all experiment results.",
    )
    
    parser.add_argument(
        "--models",
        type=str,
        nargs="+",
        default=["sd15", "sdxl", "pixart"],
        help="Models to use (for exp4, exp1/3 can use single model).",
    )
    
    parser.add_argument(
        "--exp1_model",
        type=str,
        default="sd15",
        help="Model for Experiment 1 (generative uncertainty).",
    )
    
    parser.add_argument(
        "--exp3_model",
        type=str,
        default="sd15",
        help="Model for Experiment 3 (aleatoric uncertainty).",
    )
    
    parser.add_argument(
        "--num_images",
        type=int,
        default=8,
        help="Number of images per prompt for exp1 and exp3.",
    )
    
    parser.add_argument(
        "--exp4_seed",
        type=int,
        default=0,
        help="Seed to use for Experiment 4 (should match seeds generated by generate_all_images.py).",
    )
    
    parser.add_argument(
        "--device",
        type=str,
        default="cuda",
        help="Device for models.",
    )
    
    parser.add_argument(
        "--skip_exp1",
        action="store_true",
        help="Skip Experiment 1.",
    )
    
    parser.add_argument(
        "--skip_exp3",
        action="store_true",
        help="Skip Experiment 3.",
    )
    
    parser.add_argument(
        "--skip_exp4",
        action="store_true",
        help="Skip Experiment 4.",
    )
    
    parser.add_argument(
        "--no-cache",
        action="store_true",
        help="Disable image caching.",
    )
    
    parser.add_argument(
        "--categories",
        type=str,
        nargs="+",
        default=["abstract", "concrete", "moderate", "underspecified"],
        help="Prompt categories to process.",
    )
    
    parser.add_argument(
        "--cache_dir",
        type=str,
        default="results/generated_images/images",
        help="Directory containing cached images (organized by model).",
    )
    
    return parser.parse_args()


def run_experiment(script_path: str, args_list: list) -> bool:
    """Run an experiment script and return True if successful."""
    cmd = [sys.executable, script_path] + args_list
    print(f"\n{'='*80}")
    print(f"Running: {' '.join(cmd)}")
    print(f"{'='*80}\n")
    
    result = subprocess.run(cmd, capture_output=False)
    return result.returncode == 0


def main():
    args = parse_args()
    
    prompt_dir = Path(args.prompt_dir)
    base_out_dir = Path(args.base_out_dir)
    
    # Get script paths
    scripts_dir = Path(__file__).parent
    exp1_script = scripts_dir / "run_exp1_generative.py"
    exp3_script = scripts_dir / "run_exp3_aleatoric.py"
    exp4_script = scripts_dir / "run_exp4_epistemic.py"
    
    print("="*80)
    print("Running All Experiments Across Prompt Specificity Levels")
    print("="*80)
    print(f"Categories: {args.categories}")
    print(f"Base output directory: {args.base_out_dir}")
    print()
    
    # Run Experiment 1 for each category
    if not args.skip_exp1:
        print("\n" + "="*80)
        print("EXPERIMENT 1: Generative Uncertainty")
        print("="*80)
        
        for category in args.categories:
            prompt_file = prompt_dir / f"{category}.jsonl"
            if not prompt_file.exists():
                print(f"Warning: {prompt_file} not found, skipping category {category}")
                continue
            
            out_dir = base_out_dir / "exp1_generative" / category
            csv_name = f"exp1_generative_{category}.csv"
            
            exp1_args = [
                "--prompts", str(prompt_file),
                "--out_dir", str(out_dir),
                "--model", args.exp1_model,
                "--num_images", str(args.num_images),
                "--device", args.device,
                "--csv_name", csv_name,
                "--cache_dir", args.cache_dir,
            ]
            
            if args.no_cache:
                exp1_args.append("--no-cache")
            
            success = run_experiment(str(exp1_script), exp1_args)
            if not success:
                print(f"ERROR: Experiment 1 failed for category {category}")
                return 1
    
    # Run Experiment 3 for each category
    if not args.skip_exp3:
        print("\n" + "="*80)
        print("EXPERIMENT 3: Aleatoric Uncertainty")
        print("="*80)
        
        for category in args.categories:
            prompt_file = prompt_dir / f"{category}.jsonl"
            if not prompt_file.exists():
                print(f"Warning: {prompt_file} not found, skipping category {category}")
                continue
            
            out_dir = base_out_dir / "exp3_aleatoric" / category
            csv_name = f"exp3_aleatoric_{category}.csv"
            
            exp3_args = [
                "--prompts", str(prompt_file),
                "--out_dir", str(out_dir),
                "--model", args.exp3_model,
                "--num_images", str(args.num_images),
                "--device", args.device,
                "--csv_name", csv_name,
                "--cache_dir", args.cache_dir,
            ]
            
            if args.no_cache:
                exp3_args.append("--no-cache")
            
            success = run_experiment(str(exp3_script), exp3_args)
            if not success:
                print(f"ERROR: Experiment 3 failed for category {category}")
                return 1
    
    # Run Experiment 4 (epistemic - cross-model) once for all categories
    if not args.skip_exp4:
        print("\n" + "="*80)
        print("EXPERIMENT 4: Epistemic Uncertainty (Cross-Model)")
        print("="*80)
        
        out_dir = base_out_dir / "exp4_epistemic"
        csv_name = "exp4_epistemic.csv"
        
        exp4_args = [
            "--prompt_dir", str(prompt_dir),
            "--all_categories",
            "--out_dir", str(out_dir),
            "--models"] + args.models + [
            "--seed", str(args.exp4_seed),
            "--device", args.device,
            "--csv_name", csv_name,
            "--cache_dir", args.cache_dir,
        ]
        
        if args.no_cache:
            exp4_args.append("--no-cache")
        
        success = run_experiment(str(exp4_script), exp4_args)
        if not success:
            print("ERROR: Experiment 4 failed")
            return 1
    
    print("\n" + "="*80)
    print("ALL EXPERIMENTS COMPLETED SUCCESSFULLY!")
    print("="*80)
    print(f"\nResults saved in: {args.base_out_dir}/")
    print("\nDirectory structure:")
    print("  exp1_generative/{category}/exp1_generative_{category}.csv")
    print("  exp3_aleatoric/{category}/exp3_aleatoric_{category}.csv")
    print("  exp4_epistemic/exp4_epistemic.csv (with category column)")
    
    return 0


if __name__ == "__main__":
    sys.exit(main())

